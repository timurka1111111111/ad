<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse Monitor</title>
<style>
* {
    box-sizing: border-box;
}
body {
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 100%);
    color: #fff;
    font-family: 'Segoe UI', Arial, sans-serif;
}
.container {
    max-width: 500px;
    margin: 0 auto;
    text-align: center;
}
h1 {
    font-size: 28px;
    margin-bottom: 10px;
    background: linear-gradient(135deg, #ff4dff, #9a00ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
#pulse-circle {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ff4dff, #9a00ff);
    box-shadow: 0 0 60px rgba(154, 0, 255, 0.8);
    margin: 20px auto;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
#pulse-circle::before {
    content: '';
    position: absolute;
    width: 160px;
    height: 160px;
    border-radius: 50%;
    background: #111;
}
#bpm { 
    font-size: 54px; 
    font-weight: bold; 
    margin: 0;
    color: #ff4dff;
    position: relative;
    z-index: 1;
    text-shadow: 0 0 20px rgba(255, 77, 255, 0.5);
}
#status {
    font-size: 15px;
    margin: 15px 0;
    padding: 12px;
    background: rgba(34, 34, 34, 0.6);
    border-radius: 10px;
    min-height: 60px;
    line-height: 1.6;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(154, 0, 255, 0.3);
}
button {
    padding: 15px 35px;
    font-size: 17px;
    margin: 10px 5px;
    cursor: pointer;
    border: none;
    border-radius: 25px;
    background: linear-gradient(135deg, #9a00ff, #c715ff);
    color: #fff;
    transition: all 0.3s;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(154, 0, 255, 0.4);
}
button:hover:not(:disabled) { 
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(154, 0, 255, 0.6);
}
button:disabled { 
    background: #444;
    cursor: not-allowed;
    opacity: 0.5;
    box-shadow: none;
}
#torch-btn {
    background: linear-gradient(135deg, #ff9500, #ffb84d);
    display: none;
}
#torch-btn:hover:not(:disabled) {
    box-shadow: 0 6px 20px rgba(255, 149, 0, 0.6);
}
#torch-btn.active {
    background: linear-gradient(135deg, #44ff44, #66ff66);
}
video {
    width: 100%;
    max-width: 250px;
    height: auto;
    margin: 10px auto;
    display: block;
    border: 2px solid #9a00ff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(154, 0, 255, 0.3);
}
#video-container {
    display: none;
}
.stats {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    font-size: 13px;
}
.stat-item {
    padding: 12px;
    background: rgba(34, 34, 34, 0.6);
    border-radius: 10px;
    flex: 1;
    margin: 0 5px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(154, 0, 255, 0.2);
}
.stat-item div:first-child {
    opacity: 0.7;
    font-size: 11px;
    margin-bottom: 5px;
}
.stat-item div:last-child {
    font-size: 18px;
    font-weight: bold;
    color: #ff4dff;
}
.instruction {
    background: rgba(26, 58, 26, 0.4);
    border: 2px solid #44ff44;
    border-radius: 12px;
    padding: 15px;
    margin: 15px 0;
    font-size: 13px;
    line-height: 1.8;
    backdrop-filter: blur(10px);
}
.chart-container {
    margin: 20px 0;
    padding: 15px;
    background: rgba(34, 34, 34, 0.6);
    border-radius: 12px;
    display: none;
    border: 1px solid rgba(154, 0, 255, 0.2);
}
#waveform {
    width: 100%;
    height: 100px;
    background: #0a0a0a;
    border-radius: 8px;
}
.pulse-animation {
    animation: pulse 0.3s ease-out;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.15); box-shadow: 0 0 80px rgba(154, 0, 255, 1); }
    100% { transform: scale(1); }
}
</style>
</head>
<body>

<div class="container">
    <h1>üíì Pulse Monitor</h1>
    
    <div id="pulse-circle">
        <div id="bpm">--</div>
    </div>
    
    <div id="status">–ù–∞–∂–º–∏—Ç–µ –°—Ç–∞—Ä—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</div>

    <button id="start-btn">üöÄ –°—Ç–∞—Ä—Ç</button>
    <button id="torch-btn">üí° –§–æ–Ω–∞—Ä–∏–∫</button>
    <button id="stop-btn" style="display:none;">‚èπ –°—Ç–æ–ø</button>

    <div class="instruction" style="display:none;" id="instruction">
        <strong>üì± –ö–∞–∫ –∏–∑–º–µ—Ä–∏—Ç—å –ø—É–ª—å—Å:</strong><br>
        1. –ü–æ–ª–æ–∂–∏—Ç–µ –ø–∞–ª–µ—Ü –Ω–∞ –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É<br>
        2. –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä–æ–π—Ç–µ –∫–∞–º–µ—Ä—É –∏ –≤—Å–ø—ã—à–∫—É<br>
        3. –î–µ—Ä–∂–∏—Ç–µ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ 15-20 —Å–µ–∫—É–Ω–¥<br>
        4. –Ø—Ä–∫–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 150-220
    </div>

    <div class="stats" style="display:none;" id="stats">
        <div class="stat-item">
            <div>–Ø—Ä–∫–æ—Å—Ç—å</div>
            <div id="brightness-val">0</div>
        </div>
        <div class="stat-item">
            <div>–ö–∞—á–µ—Å—Ç–≤–æ</div>
            <div id="quality-val">--</div>
        </div>
        <div class="stat-item">
            <div>–ü–∏–∫–∏</div>
            <div id="peaks-val">0</div>
        </div>
    </div>

    <div class="chart-container" id="chart-container">
        <canvas id="waveform"></canvas>
    </div>

    <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
    </div>

</div>

<script>
const video = document.getElementById('video');
const videoContainer = document.getElementById('video-container');
const circle = document.getElementById('pulse-circle');
const bpmDisplay = document.getElementById('bpm');
const statusDisplay = document.getElementById('status');
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const torchBtn = document.getElementById('torch-btn');
const statsDiv = document.getElementById('stats');
const instructionDiv = document.getElementById('instruction');
const brightnessVal = document.getElementById('brightness-val');
const qualityVal = document.getElementById('quality-val');
const peaksVal = document.getElementById('peaks-val');
const chartContainer = document.getElementById('chart-container');
const waveformCanvas = document.getElementById('waveform');
const waveCtx = waveformCanvas.getContext('2d');

let stream = null;
let videoTrack = null;
let isProcessing = false;
let brightnessHistory = [];
let filteredHistory = [];
let lastPeakTime = 0;
let pulseIntervals = [];
let peakCount = 0;
let torchEnabled = false;
let frameCount = 0;

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

waveformCanvas.width = waveformCanvas.offsetWidth * 2;
waveformCanvas.height = 200;

function drawWaveform() {
    if (filteredHistory.length < 2) return;
    
    waveCtx.fillStyle = '#0a0a0a';
    waveCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
    
    const data = filteredHistory.slice(-150);
    const step = waveformCanvas.width / data.length;
    
    const min = Math.min(...data);
    const max = Math.max(...data);
    const range = max - min || 1;
    
    waveCtx.beginPath();
    waveCtx.strokeStyle = '#9a00ff';
    waveCtx.lineWidth = 3;
    waveCtx.lineCap = 'round';
    waveCtx.lineJoin = 'round';
    
    data.forEach((val, i) => {
        const x = i * step;
        const y = waveformCanvas.height - ((val - min) / range) * (waveformCanvas.height - 40) - 20;
        
        if (i === 0) {
            waveCtx.moveTo(x, y);
        } else {
            waveCtx.lineTo(x, y);
        }
    });
    
    waveCtx.stroke();
    
    waveCtx.shadowBlur = 15;
    waveCtx.shadowColor = '#9a00ff';
    waveCtx.stroke();
    waveCtx.shadowBlur = 0;
}

function simpleMovingAverage(data, windowSize) {
    if (data.length < windowSize) return data[data.length - 1];
    
    const recent = data.slice(-windowSize);
    return recent.reduce((a, b) => a + b) / windowSize;
}

function bandpassFilter(value, history) {
    const alpha = 0.9;
    
    if (history.length === 0) return value;
    
    const lastFiltered = history[history.length - 1];
    return alpha * lastFiltered + (1 - alpha) * value;
}

function detectPeaks(data, threshold) {
    if (data.length < 10) return false;
    
    const recentData = data.slice(-10);
    const current = recentData[recentData.length - 1];
    const prev = recentData[recentData.length - 2];
    const prev2 = recentData[recentData.length - 3];
    const prev3 = recentData[recentData.length - 4];
    
    const mean = recentData.reduce((a, b) => a + b) / recentData.length;
    const variance = recentData.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / recentData.length;
    const stdDev = Math.sqrt(variance);
    
    if (stdDev < threshold) return false;
    
    if (prev > current && prev > prev2 && prev > prev3 && prev > mean + stdDev * 0.3) {
        return true;
    }
    
    return false;
}

function enableTorch(enable) {
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    if (!capabilities.torch) {
        statusDisplay.textContent = '–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –í–∫–ª—é—á–∏—Ç–µ –≤—Å–ø—ã—à–∫—É –≤—Ä—É—á–Ω—É—é!';
        return;
    }
    
    videoTrack.applyConstraints({
        advanced: [{ torch: enable }]
    })
    .then(() => {
        torchEnabled = enable;
        if (enable) {
            torchBtn.classList.add('active');
            torchBtn.textContent = 'üí° –í—ã–∫–ª —Ñ–æ–Ω–∞—Ä–∏–∫';
        } else {
            torchBtn.classList.remove('active');
            torchBtn.textContent = 'üí° –í–∫–ª —Ñ–æ–Ω–∞—Ä–∏–∫';
        }
    })
    .catch(e => {
        console.error('–û—à–∏–±–∫–∞ —Ñ–æ–Ω–∞—Ä–∏–∫–∞:', e);
    });
}

torchBtn.addEventListener('click', () => {
    enableTorch(!torchEnabled);
});

startBtn.addEventListener('click', () => {
    startBtn.disabled = true;
    statusDisplay.textContent = '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É...';
    
    const constraints = {
        video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
        },
        audio: false
    };
    
    navigator.mediaDevices.getUserMedia(constraints)
        .then(mediaStream => {
            stream = mediaStream;
            videoTrack = stream.getVideoTracks()[0];
            
            video.srcObject = stream;
            videoContainer.style.display = 'block';
            statsDiv.style.display = 'flex';
            instructionDiv.style.display = 'block';
            chartContainer.style.display = 'block';
            
            const capabilities = videoTrack.getCapabilities();
            if (capabilities.torch) {
                torchBtn.style.display = 'inline-block';
                setTimeout(() => {
                    enableTorch(true);
                }, 500);
            } else {
                statusDisplay.textContent = '–í–∫–ª—é—á–∏—Ç–µ –≤—Å–ø—ã—à–∫—É –≤—Ä—É—á–Ω—É—é!';
            }
            
            video.onplay = () => {
                statusDisplay.textContent = '–ü–æ–ª–æ–∂–∏—Ç–µ –ø–∞–ª–µ—Ü –Ω–∞ –∫–∞–º–µ—Ä—É –∏ –≤—Å–ø—ã—à–∫—É!';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                isProcessing = true;
                
                brightnessHistory = [];
                filteredHistory = [];
                pulseIntervals = [];
                peakCount = 0;
                lastPeakTime = 0;
                frameCount = 0;
                
                processFrame();
            };
            
            video.play().catch(e => {
                console.error('–û—à–∏–±–∫–∞ play:', e);
            });
        })
        .catch(e => {
            console.error('–û–®–ò–ë–ö–ê:', e);
            
            let errorMsg = '';
            if (e.name === 'NotAllowedError') {
                errorMsg = '–î–æ—Å—Ç—É–ø –æ—Ç–∫–ª–æ–Ω–µ–Ω! –†–∞–∑—Ä–µ—à–∏—Ç–µ –∫–∞–º–µ—Ä—É';
            } else if (e.name === 'NotFoundError') {
                errorMsg = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
            } else {
                errorMsg = e.message;
            }
            
            statusDisplay.textContent = errorMsg;
            startBtn.disabled = false;
        });
});

stopBtn.addEventListener('click', () => {
    isProcessing = false;
    
    if (torchEnabled) {
        enableTorch(false);
    }
    
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    
    video.srcObject = null;
    videoContainer.style.display = 'none';
    statsDiv.style.display = 'none';
    instructionDiv.style.display = 'none';
    chartContainer.style.display = 'none';
    torchBtn.style.display = 'none';
    startBtn.style.display = 'inline-block';
    startBtn.disabled = false;
    stopBtn.style.display = 'none';
    statusDisplay.textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
    bpmDisplay.textContent = '--';
});

function processFrame() {
    if (!isProcessing) return;
    
    if (video.readyState >= video.HAVE_CURRENT_DATA) {
        if (canvas.width === 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        
        try {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let redSum = 0;
            let pixelCount = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                redSum += data[i];
                pixelCount++;
            }
            
            const avgBrightness = redSum / pixelCount;
            frameCount++;
            
            brightnessVal.textContent = Math.round(avgBrightness);
            brightnessHistory.push(avgBrightness);
            
            const smoothed = simpleMovingAverage(brightnessHistory, 3);
            const filtered = bandpassFilter(smoothed, filteredHistory);
            filteredHistory.push(filtered);
            
            if (brightnessHistory.length > 300) {
                brightnessHistory.shift();
                filteredHistory.shift();
            }
            
            if (frameCount % 2 === 0) {
                drawWaveform();
            }
            
            if (avgBrightness < 120) {
                qualityVal.textContent = '–°–ª–∞–±–æ';
                qualityVal.style.color = '#ff4444';
                statusDisplay.textContent = '‚ùå –Ø—Ä–∫–æ—Å—Ç—å –Ω–∏–∑–∫–∞—è! –ü—Ä–∏–∂–º–∏—Ç–µ –ø–∞–ª–µ—Ü —Å–∏–ª—å–Ω–µ–µ';
            } else if (avgBrightness > 240) {
                qualityVal.textContent = '–Ø—Ä–∫–æ';
                qualityVal.style.color = '#ffaa00';
                statusDisplay.textContent = '‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —è—Ä–∫–æ! –û—Å–ª–∞–±—å—Ç–µ –Ω–∞–∂–∞—Ç–∏–µ';
            } else {
                qualityVal.textContent = '–û—Ç–ª–∏—á–Ω–æ';
                qualityVal.style.color = '#44ff44';
                statusDisplay.textContent = '‚úÖ –û—Ç–ª–∏—á–Ω–æ! –î–µ—Ä–∂–∏—Ç–µ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ...';
            }
            
            if (filteredHistory.length >= 50) {
                const isPeak = detectPeaks(filteredHistory, 5);
                
                if (isPeak) {
                    const now = Date.now();
                    const timeSinceLastPeak = now - lastPeakTime;
                    
                    if (timeSinceLastPeak > 400 && timeSinceLastPeak < 2000) {
                        if (lastPeakTime !== 0) {
                            const interval = timeSinceLastPeak / 1000;
                            const bpm = 60 / interval;
                            
                            if (bpm >= 45 && bpm <= 180) {
                                pulseIntervals.push(interval);
                                
                                if (pulseIntervals.length > 8) {
                                    pulseIntervals.shift();
                                }
                                
                                if (pulseIntervals.length >= 4) {
                                    const validIntervals = pulseIntervals.slice(-6);
                                    const avgInterval = validIntervals.reduce((a, b) => a + b) / validIntervals.length;
                                    const avgBpm = Math.round(60 / avgInterval);
                                    
                                    bpmDisplay.textContent = avgBpm;
                                    peakCount++;
                                    peaksVal.textContent = peakCount;
                                    
                                    circle.classList.add('pulse-animation');
                                    setTimeout(() => {
                                        circle.classList.remove('pulse-animation');
                                    }, 300);
                                }
                            }
                        }
                        lastPeakTime = now;
                    }
                }
            }
            
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞:', e);
        }
    }
    
    requestAnimationFrame(processFrame);
}
</script>

</body>
</html>
