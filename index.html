<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse Monitor</title>
<style>
* {
    box-sizing: border-box;
}
body {
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    background: #111;
    color: #fff;
    font-family: Arial, sans-serif;
}
.container {
    max-width: 500px;
    margin: 0 auto;
    text-align: center;
}
h1 {
    font-size: 24px;
    margin-bottom: 20px;
}
#pulse-circle {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ff4dff, #9a00ff);
    box-shadow: 0 0 50px rgba(154, 0, 255, 0.7);
    margin: 20px auto;
    transition: transform 0.1s ease;
}
#bpm { 
    font-size: 48px; 
    font-weight: bold; 
    margin: 20px 0;
    color: #ff4dff;
}
#status {
    font-size: 16px;
    margin: 15px 0;
    padding: 10px;
    background: #222;
    border-radius: 8px;
    min-height: 60px;
}
button {
    padding: 15px 30px;
    font-size: 18px;
    margin: 10px 5px;
    cursor: pointer;
    border: none;
    border-radius: 8px;
    background-color: #9a00ff;
    color: #fff;
    transition: background 0.2s;
    font-weight: bold;
}
button:hover:not(:disabled) { 
    background-color: #c715ff; 
}
button:disabled { 
    background-color: #444; 
    cursor: not-allowed;
    opacity: 0.6;
}
#debug-log {
    margin-top: 20px;
    padding: 15px;
    background: #1a1a1a;
    border-radius: 8px;
    font-size: 12px;
    text-align: left;
    max-height: 300px;
    overflow-y: auto;
    font-family: monospace;
}
.log-entry {
    margin: 5px 0;
    padding: 5px;
    border-left: 3px solid #9a00ff;
    padding-left: 10px;
}
.log-error {
    border-left-color: #ff4444;
    color: #ff8888;
}
.log-success {
    border-left-color: #44ff44;
    color: #88ff88;
}
video {
    width: 200px;
    height: 150px;
    margin: 10px auto;
    display: block;
    border: 2px solid #9a00ff;
    border-radius: 8px;
}
#video-container {
    display: none;
}
.stats {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    font-size: 14px;
}
.stat-item {
    padding: 10px;
    background: #222;
    border-radius: 5px;
    flex: 1;
    margin: 0 5px;
}
</style>
</head>
<body>

<div class="container">
    <h1>Pulse Monitor</h1>
<div id="pulse-circle"></div>
<div id="bpm">-- BPM</div>
<div id="status">Нажмите Старт для начала</div>

<button id="start-btn">Старт</button>
<button id="stop-btn" style="display:none;">Стоп</button>

<div class="stats" style="display:none;" id="stats">
    <div class="stat-item">
        <div>Яркость</div>
        <div id="brightness-val">0</div>
    </div>
    <div class="stat-item">
        <div>Пики</div>
        <div id="peaks-val">0</div>
    </div>
    <div class="stat-item">
        <div>FPS</div>
        <div id="fps-val">0</div>
    </div>
</div>

<div id="video-container">
    <video id="video" autoplay playsinline muted></video>
</div>

<div id="debug-log"></div>

</div>

<script>
const video = document.getElementById('video');
const videoContainer = document.getElementById('video-container');
const circle = document.getElementById('pulse-circle');
const bpmDisplay = document.getElementById('bpm');
const statusDisplay = document.getElementById('status');
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const debugLog = document.getElementById('debug-log');
const statsDiv = document.getElementById('stats');
const brightnessVal = document.getElementById('brightness-val');
const peaksVal = document.getElementById('peaks-val');
const fpsVal = document.getElementById('fps-val');

let stream = null;
let isProcessing = false;
let brightnessHistory = [];
let lastPeakTime = 0;
let pulseIntervals = [];
let peakCount = 0;
let frameCount = 0;
let lastFpsTime = Date.now();

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

function log(message, type) {
    const entry = document.createElement('div');
    const className = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : '';
    entry.className = 'log-entry ' + className;
    const time = new Date().toLocaleTimeString();
    entry.textContent = '[' + time + '] ' + message;
    debugLog.insertBefore(entry, debugLog.firstChild);
    console.log(message);
}

log('User Agent: ' + navigator.userAgent);
log('Protocol: ' + window.location.protocol);
log('HTTPS: ' + (window.location.protocol === 'https:' ? 'YES' : 'NO'), 
    window.location.protocol === 'https:' ? 'success' : 'error');

if (!navigator.mediaDevices) {
    log('navigator.mediaDevices не доступен', 'error');
    statusDisplay.textContent = 'Ваш браузер не поддерживает камеру';
    startBtn.disabled = true;
} else if (!navigator.mediaDevices.getUserMedia) {
    log('getUserMedia не доступен', 'error');
    statusDisplay.textContent = 'getUserMedia не поддерживается';
    startBtn.disabled = true;
} else {
    log('getUserMedia доступен', 'success');
    
    navigator.mediaDevices.enumerateDevices()
        .then(function(devices) {
            const cameras = devices.filter(function(d) { return d.kind === 'videoinput'; });
            log('Найдено камер: ' + cameras.length, cameras.length > 0 ? 'success' : 'error');
            cameras.forEach(function(cam, i) {
                log('  Камера ' + (i + 1) + ': ' + (cam.label || 'Без названия'));
            });
        })
        .catch(function(e) {
            log('Ошибка enumerateDevices: ' + e.message, 'error');
        });
}

startBtn.addEventListener('click', function() {
    log('=== Начало работы ===');
    startBtn.disabled = true;
    statusDisplay.textContent = 'Запрашиваем доступ к камере...';
    
    log('Запрос getUserMedia...');
    
    const constraints = {
        video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 640 },
            height: { ideal: 480 }
        },
        audio: false
    };
    
    log('Constraints: ' + JSON.stringify(constraints));
    
    navigator.mediaDevices.getUserMedia(constraints)
        .then(function(mediaStream) {
            log('Stream получен', 'success');
            stream = mediaStream;
            
            const tracks = stream.getVideoTracks();
            log('Video tracks: ' + tracks.length);
            if (tracks.length > 0) {
                const settings = tracks[0].getSettings();
                log('Разрешение: ' + settings.width + 'x' + settings.height);
                log('FacingMode: ' + (settings.facingMode || 'unknown'));
            }
            
            video.srcObject = stream;
            log('Stream установлен в video.srcObject');
            
            videoContainer.style.display = 'block';
            statsDiv.style.display = 'flex';
            
            video.onloadedmetadata = function() {
                log('Video metadata загружена', 'success');
                log('Video размер: ' + video.videoWidth + 'x' + video.videoHeight);
            };
            
            video.onloadeddata = function() {
                log('Video data загружена', 'success');
            };
            
            video.onplay = function() {
                log('Video начало воспроизведение', 'success');
                statusDisplay.textContent = 'Положите палец на камеру с обратной стороны';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                isProcessing = true;
                processFrame();
            };
            
            video.onerror = function(e) {
                log('Video error: ' + e, 'error');
                statusDisplay.textContent = 'Ошибка видео';
            };
            
            video.play()
                .then(function() {
                    log('video.play() успешно');
                })
                .catch(function(e) {
                    log('Ошибка video.play(): ' + e.message, 'error');
                });
        })
        .catch(function(e) {
            log('ОШИБКА: ' + e.name + ' - ' + e.
                message, 'error');
            
            let errorMsg = '';
            if (e.name === 'NotAllowedError') {
                errorMsg = 'Доступ к камере отклонен. Разрешите доступ!';
            } else if (e.name === 'NotFoundError') {
                errorMsg = 'Камера не найдена';
            } else if (e.name === 'NotReadableError') {
                errorMsg = 'Камера занята другим приложением';
            } else if (e.name === 'OverconstrainedError') {
                errorMsg = 'Настройки камеры не поддерживаются';
            } else {
                errorMsg = e.message;
            }
            
            statusDisplay.textContent = errorMsg;
            startBtn.disabled = false;
            startBtn.style.display = 'inline-block';
        });
});

stopBtn.addEventListener('click', function() {
    log('Остановка...');
    isProcessing = false;
    if (stream) {
        stream.getTracks().forEach(function(track) {
            track.stop();
        });
        log('Tracks остановлены');
    }
    video.srcObject = null;
    videoContainer.style.display = 'none';
    statsDiv.style.display = 'none';
    startBtn.style.display = 'inline-block';
    startBtn.disabled = false;
    stopBtn.style.display = 'none';
    statusDisplay.textContent = 'Остановлено';
    bpmDisplay.textContent = '-- BPM';
});

function processFrame() {
    if (!isProcessing) return;
    
    frameCount++;
    if (Date.now() - lastFpsTime >= 1000) {
        fpsVal.textContent = frameCount;
        frameCount = 0;
        lastFpsTime = Date.now();
    }
    
    if (video.readyState >= video.HAVE_CURRENT_DATA) {
        if (canvas.width === 0) {
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            log('Canvas: ' + canvas.width + 'x' + canvas.height);
        }
        
        try {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let redSum = 0;
            for (let i = 0; i < data.length; i += 4) {
                redSum += data[i];
            }
            const brightness = redSum / (data.length / 4);
            
            brightnessVal.textContent = Math.round(brightness);
            brightnessHistory.push(brightness);
            if (brightnessHistory.length > 300) {
                brightnessHistory.shift();
            }
            
            if (brightnessHistory.length > 10) {
                const len = brightnessHistory.length;
                const current = brightnessHistory[len - 1];
                const prev = brightnessHistory[len - 2];
                const prev2 = brightnessHistory[len - 3];
                
                if (prev > current && prev > prev2 && prev > 100) {
                    const timeSinceLastPeak = Date.now() - lastPeakTime;
                    
                    if (timeSinceLastPeak > 400) {
                        if (lastPeakTime !== 0) {
                            const interval = timeSinceLastPeak / 1000;
                            const bpm = 60 / interval;
                            
                            if (bpm >= 40 && bpm <= 180) {
                                pulseIntervals.push(interval);
                                if (pulseIntervals.length > 6) {
                                    pulseIntervals.shift();
                                }
                                
                                const sum = pulseIntervals.reduce(function(a, b) { return a + b; });
                                const avgInterval = sum / pulseIntervals.length;
                                const avgBpm = Math.round(60 / avgInterval);
                                
                                bpmDisplay.textContent = avgBpm + ' BPM';
                                peakCount++;
                                peaksVal.textContent = peakCount;
                                
                                circle.style.
                                transform = 'scale(1.2)';
                                setTimeout(function() {
                                    circle.style.transform = 'scale(1)';
                                }, 150);
                                
                                log('Пульс: ' + avgBpm + ' BPM (интервал: ' + interval.toFixed(2) + 's)');
                            }
                        }
                        lastPeakTime = Date.now();
                    }
                }
            }
            
        } catch (e) {
            log('Ошибка обработки: ' + e.message, 'error');
        }
    }
    
    requestAnimationFrame(processFrame);
}

log('Скрипт загружен', 'success');
</script>

</body>
</html>
