<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse Monitor</title>
<style>
* {
    box-sizing: border-box;
}
body {
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    background: #111;
    color: #fff;
    font-family: Arial, sans-serif;
}
.container {
    max-width: 500px;
    margin: 0 auto;
    text-align: center;
}
h1 {
    font-size: 24px;
    margin-bottom: 20px;
}
#pulse-circle {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ff4dff, #9a00ff);
    box-shadow: 0 0 50px rgba(154, 0, 255, 0.7);
    margin: 20px auto;
    transition: transform 0.2s ease;
}
#bpm { 
    font-size: 48px; 
    font-weight: bold; 
    margin: 20px 0;
    color: #ff4dff;
}
#status {
    font-size: 16px;
    margin: 15px 0;
    padding: 10px;
    background: #222;
    border-radius: 8px;
    min-height: 60px;
    line-height: 1.5;
}
button {
    padding: 15px 30px;
    font-size: 18px;
    margin: 10px 5px;
    cursor: pointer;
    border: none;
    border-radius: 8px;
    background-color: #9a00ff;
    color: #fff;
    transition: background 0.2s;
    font-weight: bold;
}
button:hover:not(:disabled) { 
    background-color: #c715ff; 
}
button:disabled { 
    background-color: #444; 
    cursor: not-allowed;
    opacity: 0.6;
}
#torch-btn {
    background-color: #ff9500;
    display: none;
}
#torch-btn:hover:not(:disabled) {
    background-color: #ffb84d;
}
#torch-btn.active {
    background-color: #44ff44;
}
#debug-log {
    margin-top: 20px;
    padding: 15px;
    background: #1a1a1a;
    border-radius: 8px;
    font-size: 11px;
    text-align: left;
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace;
}
.log-entry {
    margin: 3px 0;
    padding: 3px;
    border-left: 3px solid #9a00ff;
    padding-left: 8px;
}
.log-error {
    border-left-color: #ff4444;
    color: #ff8888;
}
.log-success {
    border-left-color: #44ff44;
    color: #88ff88;
}
.log-warning {
    border-left-color: #ffaa00;
    color: #ffcc66;
}
video {
    width: 100%;
    max-width: 300px;
    height: auto;
    margin: 10px auto;
    display: block;
    border: 2px solid #9a00ff;
    border-radius: 8px;
}
#video-container {
    display: none;
}
.stats {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    font-size: 14px;
}
.stat-item {
    padding: 10px;
    background: #222;
    border-radius: 5px;
    flex: 1;
    margin: 0 5px;
}
.instruction {
    background: #1a3a1a;
    border: 2px solid #44ff44;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    font-size: 14px;
    line-height: 1.6;
}
</style>
</head>
<body>

<div class="container">
    <h1>Pulse Monitor</h1>
<div id="pulse-circle"></div>
<div id="bpm">-- BPM</div>
<div id="status">Нажмите Старт для начала</div>

<button id="start-btn">Старт</button>
<button id="torch-btn">Фонарик</button>
<button id="stop-btn" style="display:none;">Стоп</button>

<div class="instruction" style="display:none;" id="instruction">
    <strong>Как измерить пульс:</strong><br>
    1. Положите палец на заднюю камеру<br>
    2. Полностью закройте камеру и вспышку<br>
    3. Держите неподвижно 10-15 секунд<br>
    4. Яркость должна быть 150-220
</div>

<div class="stats" style="display:none;" id="stats">
    <div class="stat-item">
        <div>Яркость</div>
        <div id="brightness-val">0</div>
    </div>
    <div class="stat-item">
        <div>Качество</div>
        <div id="quality-val">--</div>
    </div>
    <div class="stat-item">
        <div>Пики</div>
        <div id="peaks-val">0</div>
    </div>
</div>

<div id="video-container">
    <video id="video" autoplay playsinline muted></video>
</div>

<div id="debug-log"></div>

</div>

<script>
const video = document.getElementById('video');
const videoContainer = document.getElementById('video-container');
const circle = document.getElementById('pulse-circle');
const bpmDisplay = document.getElementById('bpm');
const statusDisplay = document.
getElementById('status');
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const torchBtn = document.getElementById('torch-btn');
const debugLog = document.getElementById('debug-log');
const statsDiv = document.getElementById('stats');
const instructionDiv = document.getElementById('instruction');
const brightnessVal = document.getElementById('brightness-val');
const qualityVal = document.getElementById('quality-val');
const peaksVal = document.getElementById('peaks-val');

let stream = null;
let videoTrack = null;
let isProcessing = false;
let brightnessHistory = [];
let lastPeakTime = 0;
let pulseIntervals = [];
let peakCount = 0;
let torchEnabled = false;

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

function log(message, type) {
    const entry = document.createElement('div');
    const className = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : type === 'warning' ? 'log-warning' : '';
    entry.className = 'log-entry ' + className;
    const time = new Date().toLocaleTimeString();
    entry.textContent = '[' + time + '] ' + message;
    debugLog.insertBefore(entry, debugLog.firstChild);
    console.log(message);
}

log('Protocol: ' + window.location.protocol);
log('HTTPS: ' + (window.location.protocol === 'https:' ? 'YES' : 'NO'), 
    window.location.protocol === 'https:' ? 'success' : 'error');

if (!navigator.mediaDevices) {
    log('mediaDevices не доступен', 'error');
    statusDisplay.textContent = 'Ваш браузер не поддерживает камеру';
    startBtn.disabled = true;
} else {
    log('getUserMedia доступен', 'success');
}

function enableTorch(enable) {
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    if (!capabilities.torch) {
        log('Фонарик не поддерживается на этом устройстве', 'warning');
        return;
    }
    
    videoTrack.applyConstraints({
        advanced: [{ torch: enable }]
    })
    .then(function() {
        torchEnabled = enable;
        if (enable) {
            torchBtn.classList.add('active');
            torchBtn.textContent = 'Выкл фонарик';
            log('Фонарик включен', 'success');
        } else {
            torchBtn.classList.remove('active');
            torchBtn.textContent = 'Вкл фонарик';
            log('Фонарик выключен');
        }
    })
    .catch(function(e) {
        log('Ошибка фонарика: ' + e.message, 'error');
    });
}

torchBtn.addEventListener('click', function() {
    enableTorch(!torchEnabled);
});

startBtn.addEventListener('click', function() {
    log('=== СТАРТ ===');
    startBtn.disabled = true;
    statusDisplay.textContent = 'Запрашиваем камеру...';
    
    const constraints = {
        video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
        },
        audio: false
    };
    
    navigator.mediaDevices.getUserMedia(constraints)
        .then(function(mediaStream) {
            log('Камера получена', 'success');
            stream = mediaStream;
            videoTrack = stream.getVideoTracks()[0];
            
            const settings = videoTrack.getSettings();
            log('Камера: ' + settings.width + 'x' + settings.height);
            
            video.srcObject = stream;
            videoContainer.style.display = 'block';
            statsDiv.style.display = 'flex';
            instructionDiv.style.display = 'block';
            
            const capabilities = videoTrack.getCapabilities();
            if (capabilities.torch) {
                torchBtn.style.display = 'inline-block';
                log('Фонарик доступен!', 'success');
                setTimeout(function() {
                    enableTorch(true);
                }, 500);
            } else {
                log('Фонарик НЕ доступен', 'warning');
                statusDisplay.textContent = 'Включите вспышку вручную!';
            }
            
            video.onloadedmetadata = function() {
                log('Видео загружено');
            };
            
            video.onplay = function() {
                log('Видео запущено', 'success');
                statusDisplay.textContent = 'Положите палец на камеру и вспышку!';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                isProcessing = true;
                
                brightnessHistory = [];
                pulseIntervals = [];
                peakCount = 0;
                lastPeakTime = 0;
                
                processFrame();
            };
            
            video.play()
                .catch(function(e) {
                    log('Ошибка play: ' + e.message, 'error');
                });
        })
        .catch(function(e) {
            log('ОШИБКА: ' + e.name + ' - ' + e.message, 'error');
            
            let errorMsg = '';
            if (e.name === 'NotAllowedError') {
                errorMsg = 'Доступ отклонен! Разрешите камеру';
            } else if (e.name === 'NotFoundError') {
                errorMsg = 'Камера не найдена';
            } else {
                errorMsg = e.message;
            }
            
            statusDisplay.textContent = errorMsg;
            startBtn.disabled = false;
        });
});

stopBtn.addEventListener('click', function() {
    log('Остановка');
    isProcessing = false;
    
    if (torchEnabled) {
        enableTorch(false);
    }
    
    if (stream) {
        stream.getTracks().forEach(function(track) {
            track.stop();
        });
    }
    
    video.srcObject = null;
    videoContainer.style.display = 'none';
    statsDiv.style.display = 'none';
    instructionDiv.style.display = 'none';
    torchBtn.style.display = 'none';
    startBtn.style.display = 'inline-block';
    startBtn.disabled = false;
    stopBtn.style.display = 'none';
    statusDisplay.textContent = 'Остановлено';
    bpmDisplay.textContent = '-- BPM';
});

function processFrame() {
    if (!isProcessing) return;
    
    if (video.readyState >= video.HAVE_CURRENT_DATA) {
        if (canvas.width === 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            log('Canvas: ' + canvas.width + 'x' + canvas.height);
        }
        
        try {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let redSum = 0;
            let pixelCount = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                redSum += data[i];
                pixelCount++;
            }
            
            const avgBrightness = redSum / pixelCount;
            
            brightnessVal.textContent = Math.round(avgBrightness);
            brightnessHistory.push(avgBrightness);
            
            if (brightnessHistory.length > 250) {
                brightnessHistory.shift();
            }
            
            if (avgBrightness < 100) {
                qualityVal.textContent = 'Слабо';
                qualityVal.style.color = '#ff4444';
                statusDisplay.textContent = 'Яркость низкая! Прижмите палец сильнее';
            } else if (avgBrightness > 240) {
                qualityVal.textContent = 'Ярко';
                qualityVal.style.color = '#ffaa00';
                statusDisplay.textContent = 'Слишком ярко! Ослабьте нажатие';
            } else {
                qualityVal.textContent = 'Хорошо';
                qualityVal.style.color = '#44ff44';
                statusDisplay.textContent = 'Отлично! Держите неподвижно...';
            }
            
            if (brightnessHistory.length >= 30) {
                const recentData = brightnessHistory.slice(-30);
                
                const mean = recentData.reduce(function(a, b) { return a + b; }) / recentData.length;
                
                let variance = 0;
                for (let i = 0; i < recentData.
                    length; i++) {
                    variance += Math.pow(recentData[i] - mean, 2);
                }
                variance = variance / recentData.length;
                const stdDev = Math.sqrt(variance);
                
                if (stdDev > 2 && brightnessHistory.length > 50) {
                    const len = brightnessHistory.length;
                    const current = brightnessHistory[len - 1];
                    const prev = brightnessHistory[len - 2];
                    const prev2 = brightnessHistory[len - 3];
                    const prev3 = brightnessHistory[len - 4];
                    
                    if (prev > current && prev > prev2 && prev > prev3) {
                        const now = Date.now();
                        const timeSinceLastPeak = now - lastPeakTime;
                        
                        if (timeSinceLastPeak > 350 && timeSinceLastPeak < 2000) {
                            if (lastPeakTime !== 0) {
                                const interval = timeSinceLastPeak / 1000;
                                const bpm = 60 / interval;
                                
                                if (bpm >= 40 && bpm <= 200) {
                                    pulseIntervals.push(interval);
                                    
                                    if (pulseIntervals.length > 10) {
                                        pulseIntervals.shift();
                                    }
                                    
                                    if (pulseIntervals.length >= 3) {
                                        const sum = pulseIntervals.reduce(function(a, b) { return a + b; });
                                        const avgInterval = sum / pulseIntervals.length;
                                        const avgBpm = Math.round(60 / avgInterval);
                                        
                                        bpmDisplay.textContent = avgBpm + ' BPM';
                                        peakCount++;
                                        peaksVal.textContent = peakCount;
                                        
                                        circle.style.transform = 'scale(1.3)';
                                        setTimeout(function() {
                                            circle.style.transform = 'scale(1)';
                                        }, 200);
                                        
                                        log('Пульс: ' + avgBpm + ' BPM');
                                    }
                                }
                            }
                            lastPeakTime = now;
                        }
                    }
                }
            }
            
        } catch (e) {
            log('Ошибка: ' + e.message, 'error');
        }
    }
    
    requestAnimationFrame(processFrame);
}

log('Готов к работе', 'success');
</script>

</body>
</html>
